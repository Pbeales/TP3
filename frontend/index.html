<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Supervision Process - TP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background: #f5f7fa; font-family: Arial; color: #222; }
        h1, h3 { color: #1d4ed8; }
        .container-box { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .list-group-item { background: #f0f4ff; border: 1px solid #d8e3ff; }
        .btn-primary { background: #1d4ed8; border: none; }
        .btn-primary:hover { background: #173ea6; }
        .btn-danger { background: #dc2626; border: none; }
        .chart-container { height: 350px; }
    </style>
</head>

<body class="p-4">
<div class="container">

    <h1 class="text-center mb-4">üì° Supervision Process</h1>

    <!-- FORMULAIRE -->
    <div class="container-box">
        <h3>‚öôÔ∏è Ajouter une variable</h3>

        <form id="formAdd" class="row g-3 mt-1">
            <div class="col-md-3">
                <input id="name" class="form-control" placeholder="Nom (Temp1)" required>
            </div>
            <div class="col-md-3">
                <input id="ip" class="form-control" placeholder="IP automate (192.168.1.20)" required>
            </div>
            <div class="col-md-2">
                <input id="register" type="number" class="form-control" placeholder="Registre" required>
            </div>
            <div class="col-md-2">
                <input id="frequency" type="number" class="form-control" placeholder="Fr√©quence (s)" required>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100">Ajouter</button>
            </div>
        </form>
    </div>

    <!-- LISTE + GRAPHIQUE -->
    <div class="container-box">
        <h3>üìã Variables configur√©es</h3>

        <ul id="varsList" class="list-group mt-3"></ul>

        <hr>

        <h3>üìà Graphique</h3>

        <div class="row mb-3">
            <div class="col-md-6">
                <select id="selectVar" class="form-select"></select>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <button id="btnExport" class="btn btn-outline-secondary">Exporter CSV</button>
                    <button id="btnRefresh" class="btn btn-outline-primary">Rafra√Æchir t√¢ches</button>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="chart"></canvas>
        </div>
    </div>

</div>

<script>
const API = "http://localhost:3000/api";
let chart;

/* -------------------
   CHARGER LES VARIABLES
------------------- */
async function loadVariables() {
    try {
        const res = await fetch(`${API}/variables`);
        const vars = await res.json();

        const list = document.getElementById("varsList");
        const sel = document.getElementById("selectVar");

        list.innerHTML = "";
        sel.innerHTML = "<option value=''>-- choisir --</option>";

        vars.forEach(v => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
                <span><strong>${v.name}</strong> ‚Äî IP: ${v.ip} ‚Äî Reg: ${v.register_address} ‚Äî ${v.frequency}s</span>
                <div>
                  <button class="btn btn-sm btn-danger me-2">Supprimer</button>
                </div>
            `;
            li.querySelector("button").onclick = async () => {
                if (!confirm("Supprimer cette variable ?")) return;
                await fetch(`${API}/variables/${v.id}`, { method: "DELETE" });
                await refreshSchedules();
                loadVariables();
            };
            list.appendChild(li);

            const opt = document.createElement("option");
            opt.value = v.id;
            opt.textContent = v.name;
            sel.appendChild(opt);
        });
    } catch (err) {
        console.error("loadVariables:", err);
        alert("Impossible de charger les variables (backend unreachable).");
    }
}

/* -------------------
   AJOUTER UNE VARIABLE
------------------- */
document.getElementById("formAdd").onsubmit = async (e) => {
    e.preventDefault();

    const payload = {
        name: document.getElementById("name").value,
        ip: document.getElementById("ip").value,
        register_address: parseInt(document.getElementById("register").value),
        frequency: parseInt(document.getElementById("frequency").value)
    };

    await fetch(`${API}/variables`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    document.getElementById("formAdd").reset();
    await refreshSchedules();
    await loadVariables();
};

/* -------------------
   RAFRAICHIR LES TACHES (backend)
------------------- */
async function refreshSchedules() {
    try {
        await fetch(`${API}/refresh`, { method: "POST" });
    } catch (err) {
        console.error("refreshSchedules:", err);
    }
}

/* -------------------
   AFFICHER LE GRAPHIQUE
------------------- */
async function loadChart(id) {
    if (!id) return;

    try {
        const res = await fetch(`${API}/history/${id}`);
        const data = await res.json();

        const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
        const values = data.map(d => d.value);

        if (!chart) {
            chart = new Chart(document.getElementById("chart"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Valeur",
                        data: values,
                        borderColor: "#1d4ed8",
                        backgroundColor: "rgba(29,78,216,0.15)",
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    animation: false,
                    scales: { x: { ticks: { color: "#444" } }, y: { ticks: { color: "#444" } } }
                }
            });
        } else {
            chart.data.labels = labels;
            chart.data.datasets[0].data = values;
            chart.update();
        }
    } catch (err) {
        console.error("loadChart:", err);
    }
}

/* -------------------
   EXPORT CSV
------------------- */
document.getElementById("btnExport").onclick = async () => {
    const id = document.getElementById("selectVar").value;
    if (!id) return alert("Choisir une variable pour exporter.");

    // t'affiche une boite pour choisir plage, sinon export tout
    const start = prompt("Date de d√©but (YYYY-MM-DD) - laisser vide pour tout");
    const end = prompt("Date de fin (YYYY-MM-DD) - laisser vide pour tout");

    let url = `${API}/export?id=${encodeURIComponent(id)}`;
    if (start) url += `&start=${encodeURIComponent(start)}`;
    if (end) url += `&end=${encodeURIComponent(end)}`;

    // t√©l√©chargement
    window.location = url;
};

/* -------------------
   MISE √Ä JOUR AUTO DU GRAPHIQUE
------------------- */
setInterval(() => {
    const id = document.getElementById("selectVar").value;
    if (id) loadChart(id);
}, 2000);

/* -------------------
   INIT
------------------- */
document.getElementById("selectVar").onchange = (e) => loadChart(e.target.value);
document.getElementById("btnRefresh").onclick = async () => { await refreshSchedules(); alert("T√¢ches rafra√Æchies"); };

loadVariables();
</script>

</body>
</html>
