<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Supervision Process - Multi Automates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f5f7fa; font-family: Arial, sans-serif; color: #222; }
    .container-box { background:white; padding:20px; border-radius:10px; margin-top:20px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    .list-group-item { background: #f0f4ff; border: 1px solid #d8e3ff; }
  </style>
</head>
<body class="p-4">
<div class="container">
  <h1 class="text-center mb-4">üì° Supervision Process</h1>

  <div class="container-box">
    <h3>üñß Automates</h3>
    <select id="selectAutomate" class="form-select mb-2"></select>
    <small class="text-muted">S√©lectionne l'automate √† consulter.</small>
  </div>

  <div class="container-box">
    <h3>‚öôÔ∏è Ajouter une variable</h3>
    <form id="formAdd" class="row g-3 mt-1">
      <div class="col-md-3">
        <input id="name" class="form-control" placeholder="Nom (Temp1)" required>
      </div>
      <div class="col-md-3">
        <input id="address_raw" class="form-control" placeholder="Adresse raw (%Q0.6.5)" required>
      </div>
      <div class="col-md-2">
        <select id="type" class="form-select">
          <option value="OUTPUT">%Q (SORTIE)</option>
          <option value="INPUT">%I (ENTR√âE)</option>
        </select>
      </div>
      <div class="col-md-2">
        <input id="frequency" type="number" class="form-control" placeholder="Fr√©quence (s)" required>
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary w-100">Ajouter</button>
      </div>
    </form>
  </div>

  <div class="container-box">
    <h3>üìã Variables configur√©es</h3>
    <ul id="varsList" class="list-group mt-3"></ul>
    <hr>
    <h3>üìà Graphique</h3>
    <div class="row mb-3">
      <div class="col-md-4">
        <select id="selectVar" class="form-select">
          <option value="">-- choisir --</option>
        </select>
      </div>
      <div class="col-md-8 text-end">
        <div class="btn-group" role="group">
          <button id="btnExport" class="btn btn-outline-secondary">Exporter CSV</button>
          <button id="btnRefresh" class="btn btn-outline-primary">Rafra√Æchir t√¢ches</button>
        </div>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="chart"></canvas>
    </div>
    <hr>
    <h3>üîß Lecture / √âcriture manuelle</h3>
    <div class="row g-2">
      <div class="col-md-3">
        <input id="manual_raw" placeholder="%Q0.6.5" class="form-control">
      </div>
      <div class="col-md-2">
        <button id="btnManualRead" class="btn btn-outline-success w-100">Lire</button>
      </div>
      <div class="col-md-2">
        <input id="manualWriteVal" type="number" placeholder="0 ou 1" class="form-control">
      </div>
      <div class="col-md-2">
        <button id="btnManualWrite" class="btn btn-outline-warning w-100">Ecrire</button>
      </div>
      <div class="col-md-3">
        <div id="manualResult" class="p-2 bg-light border rounded"></div>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = `${window.location.protocol}//${window.location.hostname}:3000/api`;
let automates = [];
let variables = [];
let chart = null;

async function loadAutomates() {
  const res = await fetch(`${API_BASE}/automates`);
  automates = await res.json();
  const sel = document.getElementById("selectAutomate");
  sel.innerHTML = "";
  automates.forEach(a => {
    const opt = document.createElement("option");
    opt.value = a.id;
    opt.textContent = `${a.name} (${a.ip})`;
    sel.appendChild(opt);
  });
  if (!sel.value && automates.length) sel.value = automates[0].id;
  await loadVariables();
}

async function loadVariables() {
  const res = await fetch(`${API_BASE}/variables`);
  variables = await res.json();
  const list = document.getElementById("varsList");
  const sel = document.getElementById("selectVar");
  list.innerHTML = "";
  sel.innerHTML = "<option value=''>-- choisir --</option>";

  if (!Array.isArray(variables) || variables.length === 0) {
    const li = document.createElement("li");
    li.className = "list-group-item";
    li.textContent = "Aucune variable configur√©e pour le moment.";
    list.appendChild(li);
    return;
  }

  variables.forEach(v => {
    // only show for selected automate
    const selectedAutomate = document.getElementById("selectAutomate").value;
    if (selectedAutomate && parseInt(v.automate_id,10) !== parseInt(selectedAutomate,10)) return;

    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
      <div>
        <strong>${v.name}</strong> ‚Äî ${v.address_raw} ‚Äî ${v.type} ‚Äî ${v.frequency}s
        <br><small class="text-muted">Automate: ${v.automate_name} (${v.automate_ip})</small>
      </div>
      <div>
        <button class="btn btn-sm btn-secondary me-2" data-id="${v.id}" onclick="manualRead(${v.id})">Lire</button>
        ${v.type === 'OUTPUT' ? `<button class="btn btn-sm btn-warning me-2" onclick="manualWrite(${v.id},1)">ON</button><button class="btn btn-sm btn-outline-warning me-2" onclick="manualWrite(${v.id},0)">OFF</button>` : ''}
        <button class="btn btn-sm btn-danger" onclick="deleteVar(${v.id})">Supprimer</button>
      </div>
    `;
    list.appendChild(li);

    const opt = document.createElement("option");
    opt.value = v.id;
    opt.textContent = `${v.name} (${v.address_raw})`;
    sel.appendChild(opt);
  });
}

async function manualRead(varId) {
  try {
    const res = await fetch(`${API_BASE}/variables/read/${varId}`);
    const j = await res.json();
    alert(`Valeur: ${j.value}`);
  } catch (err) {
    alert("Erreur lecture: " + err.message);
  }
}

async function manualWrite(varId, val) {
  try {
    const res = await fetch(`${API_BASE}/variables/write`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ id: varId, value: val })
    });
    const j = await res.json();
    if (j.ok) alert("Ecriture r√©ussie");
    else alert("Erreur: " + JSON.stringify(j));
    await loadVariables();
  } catch (err) {
    alert("Erreur √©criture: " + err.message);
  }
}

async function deleteVar(id) {
  if (!confirm("Supprimer ?")) return;
  await fetch(`${API_BASE}/variables/${id}`, { method: "DELETE" });
  await loadVariables();
}

document.getElementById("formAdd").onsubmit = async (e) => {
  e.preventDefault();
  const payload = {
    automate_id: document.getElementById("selectAutomate").value,
    name: document.getElementById("name").value,
    address_raw: document.getElementById("address_raw").value,
    type: document.getElementById("type").value,
    frequency: parseInt(document.getElementById("frequency").value, 10) || 5
  };
  const res = await fetch(`${API_BASE}/variables`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const err = await res.json().catch(()=>({}));
    alert(err.error || "Erreur ajout");
    return;
  }
  e.target.reset();
  await loadVariables();
};

document.getElementById("btnManualRead").onclick = async () => {
  const raw = document.getElementById("manual_raw").value.trim();
  const selAuto = document.getElementById("selectAutomate").value;
  if (!raw || !selAuto) { alert("Automate et adresse requis"); return; }
  try {
    // create temporary variable on backend (one-shot) by posting then reading -- simplified approach:
    // call the server-side read endpoint that accepts raw address via query
    const res = await fetch(`${API_BASE}/variables`);
    const vars = await res.json();
    // try find an existing variable with same raw and automate
    const found = vars.find(v => v.address_raw === raw && String(v.automate_id) === String(selAuto));
    if (found) {
      const r = await fetch(`${API_BASE}/variables/read/${found.id}`);
      const j = await r.json();
      document.getElementById("manualResult").textContent = `Valeur: ${j.value}`;
      return;
    } else {
      alert("Cette adresse n'est pas enregistr√©e. Ajoute-la d'abord via le formulaire pour la lire.");
    }
  } catch (err) {
    alert("Erreur: " + err.message);
  }
};

document.getElementById("btnManualWrite").onclick = async () => {
  const raw = document.getElementById("manual_raw").value.trim();
  const val = parseInt(document.getElementById("manualWriteVal").value,10);
  const selAuto = document.getElementById("selectAutomate").value;
  if (!raw || !selAuto || (val !== 0 && val !== 1)) { alert("Automate, adresse et valeur (0/1) requis"); return; }
  try {
    const res = await fetch(`${API_BASE}/variables`);
    const vars = await res.json();
    const found = vars.find(v => v.address_raw === raw && String(v.automate_id) === String(selAuto));
    if (!found) { alert("Cette adresse n'est pas enregistr√©e. Ajoute-la d'abord."); return; }
    if (found.type !== 'OUTPUT') { alert("Impossible d'√©crire sur une entr√©e."); return; }
    const r = await fetch(`${API_BASE}/variables/write`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ id: found.id, value: val })
    });
    const j = await r.json();
    if (j.ok) alert("√âcriture OK");
    else alert("Erreur: " + JSON.stringify(j));
  } catch (err) {
    alert("Erreur √©criture: " + err.message);
  }
};

document.getElementById("btnRefresh").onclick = async () => {
  await fetch(`${API_BASE}/refresh`, { method: "POST" });
  alert("T√¢ches cron rafra√Æchies");
};

document.getElementById("btnExport").onclick = () => {
  const id = document.getElementById("selectVar").value;
  if (!id) { alert("Choisir une variable pour exporter."); return; }
  const start = prompt("Date de d√©but (YYYY-MM-DD) - laisser vide pour tout");
  const end = prompt("Date de fin (YYYY-MM-DD) - laisser vide pour tout");
  let url = `${API_BASE}/export?id=${encodeURIComponent(id)}`;
  if (start) url += `&start=${encodeURIComponent(start)}`;
  if (end) url += `&end=${encodeURIComponent(end)}`;
  window.location = url;
};

async function loadChart(id) {
  if (!id) return;
  try {
    const res = await fetch(`${API_BASE}/history/${id}`);
    const data = await res.json();
    const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
    const values = data.map(d => d.value);
    if (!chart) {
      chart = new Chart(document.getElementById("chart"), {
        type: "line",
        data: { labels, datasets: [{ label: "Valeur", data: values, borderColor: "#1d4ed8", backgroundColor: "rgba(29,78,216,0.15)", borderWidth: 2, fill:true, tension:0.2 }] },
        options: { animation:false, responsive:true, scales: { x:{ title:{display:true, text:"Temps"}}, y:{ title:{display:true, text:"Valeur"}} } }
      });
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].data = values;
      chart.update();
    }
  } catch (err) { console.error("loadChart:", err); }
}

setInterval(() => {
  const id = document.getElementById("selectVar").value;
  if (id) loadChart(id);
}, 2000);

document.getElementById("selectVar").onchange = (e) => loadChart(e.target.value);
document.getElementById("selectAutomate").onchange = loadVariables;

loadAutomates();
</script>
</body>
</html>
