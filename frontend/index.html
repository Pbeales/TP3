<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Supervision Automate</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{background:#eef2f7;padding:20px;}
.box{background:white;padding:20px;border-radius:8px;}
td,th{text-align:center;vertical-align:middle;}
.small-muted{font-size:0.85rem;color:#666;}
</style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-center">ðŸ“¡ Supervision Automate â€” Variables (live)</h2>

  <div class="box mb-4">
    <h5>âž• Ajouter une variable</h5>
    <form id="addForm" class="row g-2 mt-2">
      <div class="col-md-3"><input id="name" class="form-control" placeholder="Nom" required></div>
      <div class="col-md-4"><input id="comment" class="form-control" placeholder="Commentaire (optionnel)"></div>
      <div class="col-md-3"><input id="address_raw" class="form-control" placeholder="%I0.5.5 / %Q0.6.7 / %IW100" required></div>
      <div class="col-md-2"><button class="btn btn-primary w-100">Ajouter</button></div>
      <div class="col-12 mt-1"><small class="small-muted">Formats : %I0.5.5, %Q0.6.7, %IW100, %QW20</small></div>
    </form>
  </div>

  <div class="box">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">ðŸ“‹ Variables en temps rÃ©el</h5>
      <button id="btnRefresh" class="btn btn-outline-secondary btn-sm">RafraÃ®chir</button>
    </div>

    <table class="table table-striped">
      <thead class="table-primary">
        <tr><th>Nom</th><th>Commentaire</th><th>Adresse</th><th>Type</th><th>Raw</th><th>Valeur</th><th>Action</th></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
const API = `http://${window.location.hostname}:3000/api`;

async function fetchValues() {
  try { 
    const res = await fetch(`${API}/values`); 
    return await res.json(); 
  } catch { return []; }
}

function escapeHtml(s) {
  return s ? String(s).replace(/[&<>"'\/=]/g, c => ({
    '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;', '/':'&#x2F;', '=':'&#x3D;'
  }[c])) : "";
}

function renderTable(rows) {
  const body = document.getElementById("tableBody"); 
  body.innerHTML = "";
  rows.forEach(r => {
    const tr = document.createElement("tr");
    const raw = (r.raw == null) ? "-" : r.raw;
    const value = (r.value == null) ? "-" : r.value;
    let displayValue = value;
    if (r.kind === "digital") displayValue = (r.value === 1 ? "ON" : r.value === 0 ? "OFF" : "-");
    const errorHtml = r.error ? `<br><small class="text-danger">${escapeHtml(r.error)}</small>` : "";
    tr.innerHTML = `<td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.comment||"")}</td><td>${escapeHtml(r.address_raw)}</td><td>${escapeHtml(r.type)}</td><td>${raw}</td><td>${displayValue}${r.unit?" "+escapeHtml(r.unit):""}${errorHtml}</td><td><button class="btn btn-sm btn-danger" onclick="deleteVar(${r.id})">Suppr</button></td>`;
    body.appendChild(tr);
  });
}

async function refresh() { renderTable(await fetchValues()); }

document.getElementById("addForm").onsubmit = async e => {
  e.preventDefault();
  const payload = {
    name: document.getElementById("name").value.trim(),
    comment: document.getElementById("comment").value.trim(),
    address_raw: document.getElementById("address_raw").value.trim()
  };
  const res = await fetch(`${API}/variables`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
  if (!res.ok) {
    const err = await res.json().catch(()=>({}));
    alert(err.error || "Erreur ajout");
    return;
  }
  e.target.reset();
  await refresh();
};

async function deleteVar(id) {
  if (!confirm("Supprimer la variable ?")) return;
  await fetch(`${API}/variables/${id}`, { method:"DELETE" });
  await refresh();
}

document.getElementById("btnRefresh").onclick = refresh;
setInterval(refresh, 1000);
refresh();
</script>
</body>
</html>
